<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üßß H√°i L·ªôc ƒê·∫ßu NƒÉm - Minigame T·∫øt 2026</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- ========================================
         M√ÄN H√åNH SETUP
         ======================================== -->
    <div class="setup-screen" id="setupScreen">
        <div class="setup-header">
            <h1>üßß Thi·∫øt L·∫≠p L√¨ X√¨ üßß</h1>
            <p>T·∫°o c√°c bao l√¨ x√¨ v·ªõi l·ªùi ch√∫c v√† s·ªë ti·ªÅn may m·∫Øn</p>
        </div>
        
        <div class="setup-container">
            <div class="setup-section">
                <label><i class="fas fa-list-ol"></i> S·ªë l∆∞·ª£ng bao l√¨ x√¨ (t·ªëi ƒëa 12)</label>
                <input type="number" id="envelopeCountInput" min="1" max="12" value="5" onchange="updateEnvelopeList()">
            </div>
            
            <button class="btn-add-envelope" onclick="addEnvelope()">
                <i class="fas fa-plus"></i> Th√™m Bao L√¨ X√¨
            </button>
            
            <div class="envelope-list" id="envelopeList">
                <!-- Danh s√°ch bao l√¨ x√¨ s·∫Ω ƒë∆∞·ª£c t·∫°o ƒë·ªông -->
            </div>
            
            <button class="btn-start-game" id="btnStartGame" onclick="startGame()">
                <i class="fas fa-play"></i> B·∫Øt ƒê·∫ßu Ch∆°i
            </button>
        </div>
    </div>

    <!-- ========================================
         CANVAS HOA R∆†I
         ======================================== -->
    <canvas id="petalCanvas"></canvas>
    
    <!-- ========================================
         ƒê√àN L·ªíNG TRANG TR√ç
         ======================================== -->
    <div class="lantern-box left">
        <div class="lantern-string"></div>
        <div class="lantern-body">
            <div class="lantern-cap-top"></div>
            <div class="lantern-text">Xu√¢n</div>
            <div class="lantern-cap-bottom"></div>
        </div>
        <div class="lantern-tassel"></div>
    </div>
    
    <div class="lantern-box right">
        <div class="lantern-string"></div>
        <div class="lantern-body">
            <div class="lantern-cap-top"></div>
            <div class="lantern-text">T·∫øt</div>
            <div class="lantern-cap-bottom"></div>
        </div>
        <div class="lantern-tassel"></div>
    </div>
    
    <!-- ========================================
         HEADER
         ======================================== -->
    <header class="header">
        <h1>üßß H√°i L·ªôc ƒê·∫ßu NƒÉm üßß</h1>
        <p>Ch·ªçn m·ªôt bao l√¨ x√¨ ƒë·ªÉ nh·∫≠n l·ªôc may m·∫Øn!</p>
    </header>
    
    <!-- ========================================
         TH√îNG TIN GAME
         ======================================== -->
    <div class="game-info">
        <i class="fas fa-gift"></i> C√≤n l·∫°i: <span id="envelopeCount">8</span> bao
    </div>
    
    <!-- ========================================
         KHU V·ª∞C GAME CH√çNH
         ======================================== -->
    <main class="game-container">
        <div class="tree-container">
            <!-- üå∏ H√åNH ·∫¢NH C√ÇY MAI - ƒê√£ s·ª≠ d·ª•ng ·∫£nh local -->
            <img src="pngtree-removebg-preview.png" 
                 alt="C√¢y Mai T·∫øt" 
                 class="tree-image">
            
            <!-- 
                üßß C√ÅC BAO L√å X√å
                ƒê∆∞·ª£c t·∫°o ƒë·ªông b·∫±ng JavaScript
            -->
            <div id="liXiContainer"></div>
        </div>
        
        <!-- C√°c n√∫t ƒëi·ªÅu khi·ªÉn -->
        <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
            <button class="btn-reset" onclick="resetGame()">
                <i class="fas fa-redo"></i> Ch∆°i L·∫°i
            </button>
            <button class="btn-reset" onclick="backToSetup()" style="background: linear-gradient(145deg, var(--gold-primary), var(--gold-dark)); color: var(--red-dark);">
                <i class="fas fa-cog"></i> Thi·∫øt L·∫≠p L·∫°i
            </button>
        </div>
    </main>
    
    <!-- ========================================
         POPUP K·∫æT QU·∫¢
         ======================================== -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <button class="modal-close" onclick="closeModal()">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-icon">üßß</div>
            <h2>Ch√∫c M·ª´ng NƒÉm M·ªõi!</h2>
            <p class="wish-text" id="wishText">L·ªùi ch√∫c s·∫Ω hi·ªán ·ªü ƒë√¢y</p>
            <p class="money-amount" id="rewardText">Ph·∫ßn th∆∞·ªüng</p>
            <p style="color: #666; font-size: 0.9rem;">
                <i class="fas fa-star" style="color: gold;"></i>
                Ch√∫c b·∫°n m·ªôt nƒÉm m·ªõi an khang th·ªãnh v∆∞·ª£ng!
            </p>
        </div>
    </div>
    
    <!-- ========================================
         CONTAINER PH√ÅO HOA
         ======================================== -->
    <div class="confetti-container" id="confettiContainer"></div>
    
    <!-- ========================================
         NH·∫†C N·ªÄN
         üéµ Thay link nh·∫°c b√™n d∆∞·ªõi b·∫±ng file mp3 c·ªßa b·∫°n
         ======================================== -->
    <audio id="bgMusic" loop preload="auto">
        <!-- Thay YOUR_MUSIC_URL b·∫±ng link nh·∫°c T·∫øt -->
        <source src="YOUR_MUSIC_URL.mp3" type="audio/mpeg">
        <!-- Ho·∫∑c d√πng link online -->
        <!-- <source src="https://example.com/nhac-tet.mp3" type="audio/mpeg"> -->
    </audio>
    
    <!-- N√∫t b·∫≠t/t·∫Øt nh·∫°c -->
    <button class="btn-music" id="btnMusic" onclick="toggleMusic()">
        <i class="fas fa-volume-up"></i>
    </button>
    
    <!-- ========================================
         JAVASCRIPT
         ======================================== -->
    <script>
        // ========================================
        // C·∫§U H√åNH GAME
        // ========================================
        
        /**
         * üìù DANH S√ÅCH L·ªúI CH√öC M·∫™U (G·ª£i √Ω)
         */
        const SAMPLE_WISHES = [
            "Ti·ªÅn v√†o nh∆∞ n∆∞·ªõc üí∞",
            "V·∫°n s·ª± nh∆∞ √Ω üåü",
            "An khang th·ªãnh v∆∞·ª£ng üè†",
            "Ph√°t t√†i ph√°t l·ªôc üíé",
            "S·ª©c kh·ªèe d·ªìi d√†o üí™",
            "C√¥ng th√†nh danh to·∫°i üéØ",
            "T·∫•n t√†i t·∫•n l·ªôc üìà",
            "NƒÉm m·ªõi h·∫°nh ph√∫c üéä",
            "Kim ng√¢n ƒë·∫ßy t√∫i üëõ",
            "M√£ ƒë√°o th√†nh c√¥ng üêé",
            "Ph√∫c l·ªôc song to√†n üçÄ",
            "Xu√¢n sang gi√†u sang üå∏"
        ];
        
        /**
         * üéÅ DANH S√ÅCH PH·∫¶N TH∆Ø·ªûNG M·∫™U (G·ª£i √Ω)
         */
        const SAMPLE_REWARDS = [
            "50.000ƒë üíµ",
            "100.000ƒë üíµ",
            "200.000ƒë üíµ",
            "500.000ƒë üí∞",
            "1.000.000ƒë üí∞",
            "Voucher gi·∫£m gi√° 20% üé´",
            "Phi·∫øu mua h√†ng 100k üõí",
            "√Åo thun limited üëï",
            "C·∫∑p v√© xem phim üé¨",
            "B·ªØa ƒÉn mi·ªÖn ph√≠ üçú",
            "Qu√† b√≠ ·∫©n üéÅ",
            "Ng√†y ngh·ªâ ph√©p üèñÔ∏è"
        ];
        
        // D·ªØ li·ªáu bao l√¨ x√¨ do ng∆∞·ªùi d√πng setup
        let envelopeData = [];
        
        // Bi·∫øn theo d√µi tr·∫°ng th√°i
        let totalEnvelopes = 0;
        let remainingEnvelopes = 0;
        let isMusicPlaying = false;
        
        // ========================================
        // SETUP SCREEN - THI·∫æT L·∫¨P BAN ƒê·∫¶U
        // ========================================
        
        /**
         * Kh·ªüi t·∫°o danh s√°ch bao l√¨ x√¨ m·∫´u khi load trang
         */
        function initSetup() {
            // T·∫°o 5 bao l√¨ x√¨ m·∫∑c ƒë·ªãnh
            updateEnvelopeList();
        }
        
        /**
         * C·∫≠p nh·∫≠t danh s√°ch bao l√¨ x√¨ theo s·ªë l∆∞·ª£ng nh·∫≠p
         */
        function updateEnvelopeList() {
            const input = document.getElementById('envelopeCountInput');
            let count = parseInt(input.value) || 5;
            
            // Gi·ªõi h·∫°n t·ª´ 1-12
            count = Math.max(1, Math.min(12, count));
            input.value = count;
            
            const list = document.getElementById('envelopeList');
            const currentCount = list.children.length;
            
            // Th√™m bao n·∫øu c·∫ßn
            if (count > currentCount) {
                for (let i = currentCount; i < count; i++) {
                    addEnvelope();
                }
            }
            // X√≥a bao n·∫øu c·∫ßn
            else if (count < currentCount) {
                for (let i = currentCount - 1; i >= count; i--) {
                    const item = list.children[i];
                    if (item) item.remove();
                }
                updateEnvelopeNumbers();
            }
            
            validateStartButton();
        }
        
        /**
         * Th√™m m·ªôt bao l√¨ x√¨ m·ªõi v√†o danh s√°ch
         */
        function addEnvelope() {
            const list = document.getElementById('envelopeList');
            const currentCount = list.children.length;
            
            if (currentCount >= 12) {
                alert('T·ªëi ƒëa 12 bao l√¨ x√¨!');
                return;
            }
            
            const index = currentCount;
            const randomWish = SAMPLE_WISHES[Math.floor(Math.random() * SAMPLE_WISHES.length)];
            const randomReward = SAMPLE_REWARDS[Math.floor(Math.random() * SAMPLE_REWARDS.length)];
            
            const item = document.createElement('div');
            item.className = 'envelope-item';
            item.id = `envelope-setup-${index}`;
            item.innerHTML = `
                <div class="envelope-item-header">
                    <h4>Bao l√¨ x√¨ #${index + 1}</h4>
                    <button class="btn-remove-envelope" onclick="removeEnvelope(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="input-group">
                    <label>L·ªùi ch√∫c:</label>
                    <input type="text" class="wish-input" placeholder="Nh·∫≠p l·ªùi ch√∫c..." value="${randomWish}">
                </div>
                <div class="input-group">
                    <label>Ph·∫ßn th∆∞·ªüng:</label>
                    <input type="text" class="reward-input" placeholder="Nh·∫≠p ph·∫ßn th∆∞·ªüng (ti·ªÅn, qu√†, voucher...)" value="${randomReward}">
                </div>
            `;
            
            list.appendChild(item);
            updateEnvelopeNumbers();
            updateEnvelopeCountInput();
            validateStartButton();
        }
        
        /**
         * X√≥a m·ªôt bao l√¨ x√¨ kh·ªèi danh s√°ch
         */
        function removeEnvelope(index) {
            const list = document.getElementById('envelopeList');
            if (list.children.length <= 1) {
                alert('Ph·∫£i c√≥ √≠t nh·∫•t 1 bao l√¨ x√¨!');
                return;
            }
            
            const item = document.getElementById(`envelope-setup-${index}`);
            if (item) {
                item.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => {
                    item.remove();
                    updateEnvelopeNumbers();
                    updateEnvelopeCountInput();
                    validateStartButton();
                }, 300);
            }
        }
        
        /**
         * C·∫≠p nh·∫≠t input s·ªë l∆∞·ª£ng bao l√¨ x√¨
         */
        function updateEnvelopeCountInput() {
            const list = document.getElementById('envelopeList');
            document.getElementById('envelopeCountInput').value = list.children.length;
        }
        
        /**
         * C·∫≠p nh·∫≠t s·ªë th·ª© t·ª± c√°c bao l√¨ x√¨
         */
        function updateEnvelopeNumbers() {
            const list = document.getElementById('envelopeList');
            const items = list.querySelectorAll('.envelope-item');
            
            items.forEach((item, idx) => {
                item.id = `envelope-setup-${idx}`;
                item.querySelector('h4').innerHTML = `Bao l√¨ x√¨ #${idx + 1}`;
                item.querySelector('.btn-remove-envelope').onclick = () => removeEnvelope(idx);
            });
        }
        
        /**
         * Ki·ªÉm tra ƒëi·ªÅu ki·ªán ƒë·ªÉ b·∫≠t n√∫t B·∫Øt ƒë·∫ßu
         */
        function validateStartButton() {
            const list = document.getElementById('envelopeList');
            const items = list.querySelectorAll('.envelope-item');
            const btn = document.getElementById('btnStartGame');
            
            let isValid = items.length > 0;
            
            items.forEach(item => {
                const wish = item.querySelector('.wish-input').value.trim();
                const reward = item.querySelector('.reward-input').value.trim();
                if (!wish || !reward) {
                    isValid = false;
                }
            });
            
            btn.disabled = !isValid;
        }
        
        /**
         * Thu th·∫≠p d·ªØ li·ªáu v√† b·∫Øt ƒë·∫ßu game
         */
        function startGame() {
            const list = document.getElementById('envelopeList');
            const items = list.querySelectorAll('.envelope-item');
            
            // Thu th·∫≠p d·ªØ li·ªáu
            envelopeData = [];
            items.forEach(item => {
                const wish = item.querySelector('.wish-input').value.trim();
                const reward = item.querySelector('.reward-input').value.trim();
                envelopeData.push({ wish, reward, opened: false });
            });
            
            // X√°o tr·ªôn ng·∫´u nhi√™n th·ª© t·ª±
            envelopeData = shuffleArray(envelopeData);
            
            // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
            totalEnvelopes = envelopeData.length;
            remainingEnvelopes = totalEnvelopes;
            
            // ·∫®n m√†n h√¨nh setup, hi·ªán game
            document.getElementById('setupScreen').classList.add('hidden');
            
            // Kh·ªüi t·∫°o game
            initEnvelopes();
        }
        
        /**
         * X√°o tr·ªôn m·∫£ng (Fisher-Yates shuffle)
         */
        function shuffleArray(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }
        
        // ========================================
        // KH·ªûI T·∫†O GAME
        // ========================================
        
        /**
         * Kh·ªüi t·∫°o c√°c bao l√¨ x√¨ tr√™n c√¢y
         */
        function initEnvelopes() {
            const container = document.getElementById('liXiContainer');
            container.innerHTML = '';
            
            // V·ªã tr√≠ c√°c bao l√¨ x√¨ (% t·ª´ g√≥c tr√™n b√™n tr√°i) - t·ªëi ƒëa 12 v·ªã tr√≠
            const allPositions = [
                { top: 8, left: 35 },
                { top: 5, left: 55 },
                { top: 18, left: 75 },
                { top: 22, left: 15 },
                { top: 35, left: 50 },
                { top: 28, left: 80 },
                { top: 42, left: 25 },
                { top: 48, left: 68 },
                { top: 12, left: 25 },
                { top: 38, left: 70 },
                { top: 55, left: 40 },
                { top: 45, left: 85 }
            ];
            
            // Ch·ªâ l·∫•y s·ªë v·ªã tr√≠ c·∫ßn thi·∫øt
            const positions = allPositions.slice(0, totalEnvelopes);
            
            for (let i = 0; i < totalEnvelopes; i++) {
                const liXi = document.createElement('div');
                liXi.className = 'li-xi';
                liXi.id = `lixi-${i}`;
                liXi.style.top = `${positions[i].top}%`;
                liXi.style.left = `${positions[i].left}%`;
                liXi.onclick = () => openEnvelope(i);
                
                liXi.innerHTML = `
                    <div class="li-xi-flap"></div>
                    <div class="li-xi-body"></div>
                `;
                
                container.appendChild(liXi);
            }
            
            // Reset tr·∫°ng th√°i opened cho t·∫•t c·∫£ bao
            envelopeData.forEach(env => env.opened = false);
            remainingEnvelopes = totalEnvelopes;
            updateEnvelopeCount();
        }
        
        /**
         * C·∫≠p nh·∫≠t s·ªë bao c√≤n l·∫°i
         */
        function updateEnvelopeCount() {
            document.getElementById('envelopeCount').textContent = remainingEnvelopes;
        }
        
        // ========================================
        // X·ª¨ L√ù M·ªû BAO L√å X√å
        // ========================================
        
        /**
         * X·ª≠ l√Ω khi ng∆∞·ªùi d√πng click v√†o bao l√¨ x√¨
         * @param {number} index - Ch·ªâ s·ªë bao l√¨ x√¨
         */
        function openEnvelope(index) {
            const envelope = document.getElementById(`lixi-${index}`);
            
            // Ki·ªÉm tra n·∫øu bao ƒë√£ m·ªü
            if (envelope.classList.contains('opened') || envelope.classList.contains('shaking')) {
                return;
            }
            
            // Ki·ªÉm tra d·ªØ li·ªáu bao l√¨ x√¨
            if (!envelopeData[index] || envelopeData[index].opened) {
                return;
            }
            
            // Th√™m hi·ªáu ·ª©ng rung
            envelope.classList.add('shaking');
            
            // Sau khi rung xong, m·ªü bao
            setTimeout(() => {
                envelope.classList.remove('shaking');
                envelope.classList.add('opened');
                
                // ƒê√°nh d·∫•u ƒë√£ m·ªü
                envelopeData[index].opened = true;
                
                // Gi·∫£m s·ªë bao c√≤n l·∫°i
                remainingEnvelopes--;
                updateEnvelopeCount();
                
                // L·∫•y l·ªùi ch√∫c v√† ph·∫ßn th∆∞·ªüng t·ª´ d·ªØ li·ªáu ƒë√£ setup
                const { wish, reward } = envelopeData[index];
                
                // Hi·ªÉn th·ªã popup
                showModal(wish, reward);
                
                // B·∫Øn ph√°o hoa
                launchConfetti();
            }, 500);
        }
        
        // ========================================
        // POPUP / MODAL
        // ========================================
        
        /**
         * Hi·ªÉn th·ªã popup k·∫øt qu·∫£
         * @param {string} wish - L·ªùi ch√∫c
         * @param {string} reward - Ph·∫ßn th∆∞·ªüng
         */
        function showModal(wish, reward) {
            document.getElementById('wishText').textContent = wish;
            document.getElementById('rewardText').textContent = reward;
            document.getElementById('modalOverlay').classList.add('active');
        }
        
        /**
         * ƒê√≥ng popup
         */
        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }
        
        /**
         * Format s·ªë ti·ªÅn th√†nh chu·ªói VND
         * @param {number} amount - S·ªë ti·ªÅn
         * @returns {string} - Chu·ªói ti·ªÅn ƒë√£ format
         */
        function formatMoney(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }
        
        // Click b√™n ngo√†i ƒë·ªÉ ƒë√≥ng modal
        document.getElementById('modalOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
        
        // ========================================
        // HI·ªÜU ·ª®NG PH√ÅO HOA (CONFETTI)
        // ========================================
        
        /**
         * B·∫Øn ph√°o hoa confetti
         */
        function launchConfetti() {
            const container = document.getElementById('confettiContainer');
            const colors = ['#ff0000', '#ffd700', '#ff69b4', '#00ff00', '#00bfff', '#ff8c00'];
            const shapes = ['square', 'circle', 'triangle'];
            
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                
                const color = colors[Math.floor(Math.random() * colors.length)];
                const shape = shapes[Math.floor(Math.random() * shapes.length)];
                
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.top = '-10px';
                confetti.style.backgroundColor = color;
                confetti.style.opacity = '1';
                
                // T·∫°o h√¨nh d·∫°ng
                if (shape === 'circle') {
                    confetti.style.borderRadius = '50%';
                } else if (shape === 'triangle') {
                    confetti.style.width = '0';
                    confetti.style.height = '0';
                    confetti.style.backgroundColor = 'transparent';
                    confetti.style.borderLeft = '5px solid transparent';
                    confetti.style.borderRight = '5px solid transparent';
                    confetti.style.borderBottom = `10px solid ${color}`;
                }
                
                container.appendChild(confetti);
                
                // Animation r∆°i
                const duration = 2 + Math.random() * 2;
                const xMove = (Math.random() - 0.5) * 200;
                const rotation = Math.random() * 720;
                
                confetti.animate([
                    { 
                        transform: 'translateY(0) translateX(0) rotate(0deg)',
                        opacity: 1
                    },
                    { 
                        transform: `translateY(${window.innerHeight + 100}px) translateX(${xMove}px) rotate(${rotation}deg)`,
                        opacity: 0
                    }
                ], {
                    duration: duration * 1000,
                    easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
                });
                
                // X√≥a confetti sau khi animation xong
                setTimeout(() => {
                    confetti.remove();
                }, duration * 1000);
            }
        }
        
        // ========================================
        // HI·ªÜU ·ª®NG HOA R∆†I (CANVAS)
        // ========================================
        
        const canvas = document.getElementById('petalCanvas');
        const ctx = canvas.getContext('2d');
        let petals = [];
        
        /**
         * Thi·∫øt l·∫≠p k√≠ch th∆∞·ªõc canvas
         */
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        
        /**
         * Class c√°nh hoa
         */
        class Petal {
            constructor() {
                this.reset();
            }
            
            reset() {
                this.x = Math.random() * canvas.width;
                this.y = -20;
                this.size = Math.random() * 8 + 5;
                this.speedY = Math.random() * 2 + 1;
                this.speedX = Math.random() * 2 - 1;
                this.rotation = Math.random() * 360;
                this.rotationSpeed = Math.random() * 3 - 1.5;
                this.opacity = Math.random() * 0.5 + 0.5;
                
                // M√†u hoa mai (v√†ng) ho·∫∑c hoa ƒë√†o (h·ªìng)
                this.color = Math.random() > 0.5 ? 
                    `rgba(255, ${200 + Math.random() * 55}, ${50 + Math.random() * 50}, ${this.opacity})` :
                    `rgba(255, ${150 + Math.random() * 50}, ${180 + Math.random() * 50}, ${this.opacity})`;
            }
            
            update() {
                this.y += this.speedY;
                this.x += this.speedX + Math.sin(this.y / 50) * 0.5;
                this.rotation += this.rotationSpeed;
                
                if (this.y > canvas.height + 20) {
                    this.reset();
                }
            }
            
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation * Math.PI / 180);
                
                // V·∫Ω c√°nh hoa
                ctx.beginPath();
                ctx.fillStyle = this.color;
                
                // H√¨nh c√°nh hoa 5 c√°nh
                for (let i = 0; i < 5; i++) {
                    ctx.ellipse(0, -this.size/2, this.size/3, this.size/2, (i * 72) * Math.PI / 180, 0, Math.PI * 2);
                }
                ctx.fill();
                
                // Nh·ª•y hoa
                ctx.beginPath();
                ctx.fillStyle = 'rgba(255, 215, 0, 0.8)';
                ctx.arc(0, 0, this.size/5, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.restore();
            }
        }
        
        /**
         * Kh·ªüi t·∫°o c√°c c√°nh hoa
         */
        function initPetals() {
            petals = [];
            const petalCount = Math.min(50, Math.floor(canvas.width / 20));
            
            for (let i = 0; i < petalCount; i++) {
                const petal = new Petal();
                petal.y = Math.random() * canvas.height;
                petals.push(petal);
            }
        }
        
        /**
         * V√≤ng l·∫∑p animation hoa r∆°i
         */
        function animatePetals() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            petals.forEach(petal => {
                petal.update();
                petal.draw();
            });
            
            requestAnimationFrame(animatePetals);
        }
        
        // ========================================
        // ƒêI·ªÄU KHI·ªÇN NH·∫†C
        // ========================================
        
        /**
         * B·∫≠t/t·∫Øt nh·∫°c n·ªÅn
         */
        function toggleMusic() {
            const audio = document.getElementById('bgMusic');
            const btn = document.getElementById('btnMusic');
            
            if (isMusicPlaying) {
                audio.pause();
                btn.classList.add('muted');
                btn.innerHTML = '<i class="fas fa-volume-mute"></i>';
            } else {
                audio.play().catch(e => {
                    console.log('Kh√¥ng th·ªÉ ph√°t nh·∫°c:', e);
                });
                btn.classList.remove('muted');
                btn.innerHTML = '<i class="fas fa-volume-up"></i>';
            }
            
            isMusicPlaying = !isMusicPlaying;
        }
        
        // ========================================
        // RESET GAME
        // ========================================
        
        /**
         * Ch∆°i l·∫°i t·ª´ ƒë·∫ßu (c√πng d·ªØ li·ªáu)
         */
        function resetGame() {
            closeModal();
            // X√°o tr·ªôn l·∫°i th·ª© t·ª±
            envelopeData = shuffleArray(envelopeData);
            initEnvelopes();
        }
        
        /**
         * Quay v·ªÅ m√†n h√¨nh setup
         */
        function backToSetup() {
            closeModal();
            document.getElementById('setupScreen').classList.remove('hidden');
        }
        
        // ========================================
        // KH·ªûI ƒê·ªòNG
        // ========================================
        
        // Khi trang t·∫£i xong
        window.addEventListener('load', () => {
            resizeCanvas();
            initPetals();
            animatePetals();
            initSetup(); // Hi·ªán m√†n h√¨nh setup thay v√¨ b·∫Øt ƒë·∫ßu game ngay
        });
        
        // Khi thay ƒë·ªïi k√≠ch th∆∞·ªõc m√†n h√¨nh
        window.addEventListener('resize', () => {
            resizeCanvas();
            initPetals();
        });
        
        // Ph√≠m t·∫Øt ESC ƒë·ªÉ ƒë√≥ng modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>